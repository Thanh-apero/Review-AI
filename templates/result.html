<!DOCTYPE html>
<html>
<head>
    <title>PR Analysis Results</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .efficiency-high {
            color: green;
        }
        .efficiency-medium {
            color: orange;
        }
        .efficiency-low {
            color: red;
        }
    </style>
</head>
<body>
<div class="container-fluid mt-5">
    <h1 class="mb-4">Pull Request Analysis Results</h1>

    <!-- Tổng quan -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Tổng số Pull Requests</h5>
                    <p class="card-text display-6">{{ stats.total_prs }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Tổng thời gian ước tính</h5>
                    <p class="card-text display-6">{{ stats.total_estimate }}h</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Tổng thời gian thực tế</h5>
                    <p class="card-text display-6">{{ stats.total_actual }}h</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Hiệu suất trung bình</h5>
                    {% set total_efficiency = (stats.total_estimate / stats.total_actual * 100) if stats.total_actual >
                    0 else 100 %}
                    <p class="card-text display-6 
                        {{'efficiency-high' if total_efficiency >= 90 else 'efficiency-medium' if total_efficiency >= 70 else 'efficiency-low'}}">
                        {{ "%.1f"|format(total_efficiency) }}%
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Biểu đồ -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Thời gian theo Developer</h5>
                    <canvas id="developerChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">So sánh Estimate vs Actual</h5>
                    <canvas id="timeComparisonChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Thống kê theo Developer -->
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">Thống kê theo Developer</h5>
            <table id="developerTable" class="table table-striped">
                <thead>
                <tr>
                    <th>Developer</th>
                    <th>Số lượng PRs</th>
                    <th>Thời gian ước tính (h)</th>
                    <th>Thời gian thực tế (h)</th>
                    <th>Chênh lệch (h)</th>
                    <th>Hiệu suất</th>
                </tr>
                </thead>
                <tbody>
                {% for dev, dev_stats in stats.developers.items() %}
                {% set efficiency = (dev_stats.total_estimate / dev_stats.total_actual * 100) if dev_stats.total_actual
                > 0 else 100 %}
                <tr>
                    <td>{{ dev }}</td>
                    <td>{{ dev_stats.total_prs }}</td>
                    <td>{{ "%.2f"|format(dev_stats.total_estimate) }}</td>
                    <td>{{ "%.2f"|format(dev_stats.total_actual) }}</td>
                    <td>{{ "%.2f"|format(dev_stats.total_actual - dev_stats.total_estimate) }}</td>
                    <td class="{{'efficiency-high' if efficiency >= 90 else 'efficiency-medium' if efficiency >= 70 else 'efficiency-low'}}">
                        {{ "%.1f"|format(efficiency) }}%
                    </td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Thống kê theo Project -->
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">Thống kê theo Project</h5>
            <table id="projectTable" class="table table-striped">
                <thead>
                <tr>
                    <th>Project (AIP)</th>
                    <th>Số lượng PRs</th>
                    <th>Thời gian ước tính (h)</th>
                    <th>Thời gian thực tế (h)</th>
                    <th>Hiệu suất</th>
                    <th>Developers</th>
                </tr>
                </thead>
                <tbody>
                {% for project, project_stats in stats.projects.items() %}
                {% set efficiency = (project_stats.total_estimate / project_stats.total_actual * 100) if
                project_stats.total_actual > 0 else 100 %}
                <tr>
                    <td>{{ project }}</td>
                    <td>{{ project_stats.total_prs }}</td>
                    <td>{{ "%.2f"|format(project_stats.total_estimate) }}</td>
                    <td>{{ "%.2f"|format(project_stats.total_actual) }}</td>
                    <td class="{{'efficiency-high' if efficiency >= 90 else 'efficiency-medium' if efficiency >= 70 else 'efficiency-low'}}">
                        {{ "%.1f"|format(efficiency) }}%
                    </td>
                    <td>{{ project_stats.developers|join(", ") }}</td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Bảng chi tiết -->
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">Chi tiết Pull Requests</h5>
            <table id="prsTable" class="table table-striped">
                <thead>
                <tr>
                    <th>Issue Number</th>
                    <th>Title</th>
                    <th>Creator</th>
                    <th>Estimate Time</th>
                    <th>Actual Time</th>
                    <th>Hiệu suất</th>
                    <th>Created Date</th>
                    <th>Link</th>
                </tr>
                </thead>
                <tbody>
                {% for pr in prs %}
                {% set estimate = pr.estimate_time.replace('h', '') | float %}
                {% set actual = pr.actual_time.replace('h', '') | float %}
                {% set efficiency = (estimate / actual * 100) if actual > 0 else 100 %}
                <tr>
                    <td>{{ pr.issue_number }}</td>
                    <td>{{ pr.title }}</td>
                    <td>{{ pr.creator }}</td>
                    <td>{{ pr.estimate_time }}</td>
                    <td>{{ pr.actual_time }}</td>
                    <td class="{{'efficiency-high' if efficiency >= 90 else 'efficiency-medium' if efficiency >= 70 else 'efficiency-low'}}">
                        {{ "%.1f"|format(efficiency) }}%
                    </td>
                    <td>{{ pr.created_at }}</td>
                    <td><a href="{{ pr.url }}" target="_blank">View PR</a></td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // DataTable initialization
    $(document).ready(function() {
        $('#prsTable').DataTable({
            order: [[6, 'desc']],
            pageLength: 25
        });
        $('#developerTable').DataTable({
            order: [[1, 'desc']],
            pageLength: 25
        });
        $('#projectTable').DataTable({
            order: [[1, 'desc']],
            pageLength: 25
        });
    });

    // Developer Chart
    const developerData = {
        labels: [{% for dev, stats in stats.developers.items() %}'{{ dev }}',{% endfor %}],
        datasets: [
            {
                label: 'Số lượng PRs',
                data: [{% for dev, stats in stats.developers.items() %}{{ stats.total_prs }},{% endfor %}],
                backgroundColor: 'rgba(75, 192, 192, 0.5)',
                yAxisID: 'y1'
            },
            {
                label: 'Thời gian ước tính (h)',
                data: [{% for dev, stats in stats.developers.items() %}{{ stats.total_estimate }},{% endfor %}],
                backgroundColor: 'rgba(54, 162, 235, 0.5)',
                yAxisID: 'y'
            },
            {
                label: 'Thời gian thực tế (h)',
                data: [{% for dev, stats in stats.developers.items() %}{{ stats.total_actual }},{% endfor %}],
                backgroundColor: 'rgba(255, 99, 132, 0.5)',
                yAxisID: 'y'
            }
        ]
    };

    new Chart(document.getElementById('developerChart'), {
        type: 'bar',
        data: developerData,
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: 'Thời gian (giờ)'
                    }
                },
                y1: {
                    beginAtZero: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Số lượng PRs'
                    }
                }
            }
        }
    });

    // Time Comparison Chart
    const timeComparisonData = {
        labels: ['Tổng thời gian'],
        datasets: [
            {
                label: 'Ước tính',
                data: [{{ stats.total_estimate }}],
                backgroundColor: 'rgba(54, 162, 235, 0.5)',
            },
            {
                label: 'Thực tế',
                data: [{{ stats.total_actual }}],
                backgroundColor: 'rgba(255, 99, 132, 0.5)',
            }
        ]
    };

    new Chart(document.getElementById('timeComparisonChart'), {
        type: 'bar',
        data: timeComparisonData,
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Thời gian (giờ)'
                    }
                }
            }
        }
    });
</script>
</body>
</html>
